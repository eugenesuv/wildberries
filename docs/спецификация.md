Ниже — техническое задание уровня “фронт + бэк” для эволюции проекта из “гороскопные скидки” в “генератор акций”. Включает расширение API-контрактов и схемы БД, статусы/процессы, и фронтовые флоу/компоненты. Код писать не нужно — описаны ручки (контракты), модели и поведение.

1. Домены и статусы

1.1. Домены

* Promotion (акция)

* Theme (тематика) и Segments (сегменты акции — динамические, зависят от темы)

* Identification (режим идентификации пользователя: тест-вопросы или по профилю)

* Test (вопросы/ответы + дерево маршрутизации ответов)

* Slot Model (модель слотов: аукцион/фиксированная цена)

* Slot Pricing (цены по позициям для фиксированной модели)

* Product (товары)

* Seller Participation (ставки/покупка слотов)

* Moderation (модерация заявок селлеров)

* AI Generation (генерация тем, сегментов, текста, вопросов/дерева)

1.2. Статусы Promotion

* NOT_READY — черновик, не хватает данных

* READY_TO_START — можно запускать

* RUNNING — активна

* PAUSED — приостановлена

* COMPLETED — завершена

1. Расширение БД (SQL-модели; новые таблицы/колонки)

2.1. promotion (расширение)

* id PK

* name text

* description text

* theme text (machine_name) — например 'zodiac' | 'harry-potter' | ...

* date_from timestamptz

* date_to timestamptz

* status enum('NOT_READY','READY_TO_START','RUNNING','PAUSED','COMPLETED')

* identification_mode enum('questions','user_profile')

* pricing_model enum('auction','fixed')

* slot_count int not null default 10

* min_discount int

* max_discount int

* stop_factors jsonb (list of strings)

* created_at, updated_at, deleted_at

2.2. segment (новая)

* id PK

* promotion_id FK app.promotion(id)

* name text (e.g., “Лев”, “Гриффиндор”, “Весна”)

* category_id int null (опционально)

* category_name text null

* color/accent optional (для визуализации)

* order_index int (для сортировки)

* created_at, updated_at

2.3. test_question (новая)

* id PK

* promotion_id FK

* text text

* order_index int

* created_at, updated_at

2.4. test_option (новая)

* id PK

* question_id FK

* text text

* value text (машинное значение)

* order_index int

* created_at, updated_at

2.5. test_answer_tree (новая)

* id PK

* promotion_id FK

* node_id uuid

* parent_node_id uuid null

* label text

* value text

* created_at

2.6. slot (новая)

* id PK

* promotion_id FK

* segment_id FK

* position int (1..N)

* pricing_type enum('auction','fixed') (дублируем из promotion для денормализации или приводим к актуальному)

* price bigint null (для fixed)

* auction_id FK app.auction(id) null (если auction)

* status enum('available','occupied','pending','moderation','rejected')

* seller_id int null

* product_id int null

* created_at, updated_at

2.7. Изменения существующих

* horoscope — для гороскопной темы остаётся (promotion_id, zodiac_id, text, category_id). Для универсальности можно:

  * либо оставить horoscope как специфичную для темы “zodiac”;

  * либо в будущем мигрировать на segment_text (segment_id, text, …).

* product — без изменений.

* auction, bet — остаются, но привязываем к slot (auction.slot_id) вместо horoscope_id+position.

2.8. moderation (новая)

* id PK

* promotion_id FK

* segment_id FK

* slot_id FK

* seller_id

* product_id

* discount int

* stop_factors jsonb

* status enum('pending','approved','rejected')

* created_at, updated_at, moderated_at, moderator_id

1. API: Контракты (REST). Без кода, только схемы.

3.1. Публичные (Buyer) GET /promotions/current

* resp 200: { id, name, description, theme, status, date_from, date_to, segments: [{id,name,category_name}], hero:{title,subtitle,gradient?} }

GET /promotions/{promotionId}/segments/{segmentId}/products

* query: filters (category, onlyDiscounts, sort, page, per_page)

* resp 200: { items:[{id,name,image,price,old_price,discount,badge?}], total, page, per_page, completed:boolean }

POST /identification/start

* body: { promotionId }

* resp 200: { method: 'questions'|'user_profile', test?: { questions:[{id,text,options:[{id,text,value}]}] } }

POST /identification/answer

* body: { promotionId, questionId, optionId }

* resp 200: { nextQuestionId|null, resultSegmentId|null }

3.2. Продавец (Seller) GET /seller/actions

* resp 200: [{ id, name, status, date_from, date_to, category_hint?, theme }]

GET /seller/actions/{promotionId}/segments

* resp 200: [{ id, name, category_name, available_slots:int, total_slots:int, status:'available'|'full', reach? }]

GET /seller/actions/{promotionId}/segments/{segmentId}/slots

* resp 200: { auction: [{ slotId, position, currentBid, minBid, bidStep, timeLeft, topBidderName? }] , fixed: [{ slotId, position, price, status:'available'|'occupied' }] }

POST /seller/slot/bid

* body: { slotId, amount }

* resp 200: { status:'ok', yourBid:{slotId, amount}, outbid?:boolean }

* 400 валидация minBid/step

POST /seller/slot/buy-fixed

* body: { slotId, product:{name, price, discount, imageUrl?} }

* resp 200: { status:'pending_moderation', slotId, applicationId }

POST /seller/slot/cancel

* body: { slotId }

* resp 200: { status:'ok' } | 403, если не разрешено

GET /seller/applications

* resp 200: [{ id, promotionId, segmentId, slotId, productName, discount, status }]

3.3. Админ (Admin) POST /admin/promotions

* body: { name, description, theme, date_from, date_to, identification_mode, pricing_model, slot_count, min_discount, max_discount, stop_factors: [string] }

* resp 201: { id, status:'NOT_READY' }

GET /admin/promotions/{id}

* resp 200: { id, name, description, theme, status, dates, identification_mode, pricing_model, slot_count, min_discount, max_discount, stop_factors, segments:[{id,name,category_name,order_index}], fixed_prices?: { [position:number]: price }, test:{ questions:[{id,text,options:[{id,text,value}]}], answerTree:[{node_id,parent_node_id,label,value}] } }

PATCH /admin/promotions/{id}

* body: частичное обновление (любые поля из создания)

* resp 200 { status:'ok' }

POST /admin/promotions/{id}/segments/generate

* body: { use_theme:boolean, limit?:number }

* resp 200: { segments:[{id,name,category_name}] }

POST /admin/promotions/{id}/segments

* body: { name, category_name, order_index? }

* resp 201: { id, name, category_name }

PATCH /admin/promotions/{id}/segments/{segmentId}

* body: { name?, category_name?, order_index? }

* resp 200 { status:'ok' }

DELETE /admin/promotions/{id}/segments/{segmentId}

* resp 200 { status:'ok' }

POST /admin/promotions/{id}/segments/shuffle-categories

* resp 200 { status:'ok' }

PUT /admin/promotions/{id}/fixed-prices

* body: { prices: [{ position:int, price: int }] } // 1..slot_count

* resp 200 { status:'ok' }

PUT /admin/promotions/{id}/status

* body: { status: 'NOT_READY'|'READY_TO_START'|'RUNNING'|'PAUSED'|'COMPLETED' }

* resp 200 { status:'ok' }

POST /admin/promotions/{id}/test/generate

* body: { type: 'questions' | 'answer_tree' }

* resp 200: { questions?[], answerTree?[] }

POST /admin/promotions/{id}/test/questions

* body: { questions:[{text, options:[{text,value}]}] }

* resp 200 { status:'ok' }

POST /admin/promotions/{id}/test/answer-tree

* body: { nodes:[{node_id,parent_node_id,label,value}] }

* resp 200 { status:'ok' }

GET /admin/promotions/{id}/moderation/applications

* query: status? (pending|approved|rejected)

* resp 200: [{ id, sellerId, segmentId, slotId, productName, price, discount, stop_factors, status }]

POST /admin/moderation/{applicationId}/approve

* resp 200 { status:'ok' }

POST /admin/moderation/{applicationId}/reject

* body: { reason? }

* resp 200 { status:'ok' }

POST /admin/promotions/{id}/ai/text

* body: { segmentId?, seed_text? }

* resp 200: { text }

3.4. Сервисные (AI) POST /ai/themes

* resp 200: { themes:[{value,label}] }

POST /ai/segments

* body: { theme, limit? }

* resp 200: { segments:[{name, category_name?}] }

POST /ai/questions

* body: { theme }

* resp 200: { questions:[{text, options:[{text,value}]}] }

POST /ai/answer-tree

* body: { theme }

* resp 200: { nodes:[{node_id,parent_node_id,label,value}] }

1. Бизнес-логика и процессы

4.1. Создание/настройка акции (Админ)

* Создание промо: POST /admin/promotions

* Тематика: выбор из справочника + AI-помощник (/ai/themes)

* Сегменты:

  * Генерация по теме (/admin/promotions/{id}/segments/generate)

  * CRUD сегментов (add/edit/remove)

  * Shuffle категорий у сегментов

* Модель цен:

  * auction: minPrice, bidStep, слоты генерируются по slot_count на сегмент

  * fixed: PUT /fixed-prices — цены по позициям 1..N

* Идентификация:

  * questions: генерация вопросов и дерева (AI), CRUD вопросов, загрузка дерева

  * user_profile: использование демографии (возраст, дата рождения, пол, город)

* Валидатор “готовности” (NOT_READY → READY_TO_START):

  * проверка: есть сегменты, есть модель цен с валидными параметрами (fixed имеет цены для 1..N), идентификация корректна (если questions — есть вопросы; если profile — ок), даты валидны

* RUNNING: слоты публикуются, селлеры видят доступные сегменты/слоты

* COMPLETED: покупателям отдаём completed=true на лендинге акций

4.2. Участие селлеров

* Список доступных акций/сегментов/слотов

* Аукцион:

  * POST /seller/slot/bid, валидация: minBid и шаг, конкуренция, нотификации (Kafka/WS события auction_changed)

* Фиксированная цена:

  * POST /seller/slot/buy-fixed, установка статуса slot.pending, создание заявки модерирования

* Отмена (если разрешено):

  * POST /seller/slot/cancel — ограничения по времени/статусу

* Заявки:

  * GET /seller/applications — статусы pending/approved/rejected, связь со слотами

4.3. Модерация (Админ)

* GET /admin/promotions/{id}/moderation/applications

* approve/reject — переводит slot в occupied|available, присваивает product_id, задаёт бейдж “прошёл модерацию”

* стоп-факторы: авто-отказ по отмеченным stop_factors

4.4. Витрина (Buyer)

* GET /promotions/current

* GET сегментных продуктов: фильтры (категория/только скидки), состояния: empty, completed

* Идентификация:

  * если unknown:

    * method=questions: последовательно выдаём вопросы (POST /identification/start/answer) до получения resultSegmentId, сохраняем в профиле/LS

    * method=user_profile: маппинг профиля на сегмент (на бэке), возвращаем resultSegmentId сразу

1. Требования к фронтенду

5.1. Admin

* Settings UI расширить:

  * Поддержка генерации тем (кнопка, показ 3 тем от AI)

  * Сегменты: список, CRUD сегментов, селект категории, кнопка Shuffle

  * Модель цен: auction/fixed; для fixed — матрица цен по позициям 1..slot_count

  * Идентификация: переключатель questions/user_profile

  * Вопросы и ответы: CRUD, генерация AI, вывод дерева (json/визуальное дерево)

  * Валидации и блокировка “Сохранить” при NOT_READY (или показывать предупреждения)

  * Переходы статусов: кнопка “Запустить”, “Пауза”, “Завершить”

* Moderation:

  * Таблицы заявок, статусы, массовое одобрение без стоп-факторов, диалог детализации

5.2. Seller

* Actions List: фильтры по категориям/статусам

* Segments Grid: статусы, охват, переход к слоту

* Slot Market:

  * Вкладки: аукцион vs фиксированные слоты

  * Для аукциона: форма ставки, мин и шаг

  * Для фиксированной цены: кнопка купить -> форма товара -> отправка -> “на модерации”

  * Обновления по событиям (если будет WS)

* Confirmation: итог заявки/чек

5.3. Buyer

* Главная (баннеры с A/B): ротация, hover-эффекты, лоадер и fallback

* Promotion Landing:

  * Hero + рекоменд. категория, состояния completed/empty

  * Фильтры (моб-аккордеон)

  * Grid товаров, быстрый просмотр, избранное

* Идентификация:

  * Модалка теста (questions) с прогрессом; “Запомнить мой сегмент”

  * Если mode=user_profile — сразу редирект в сегмент (после backend-определения)

1. Нефункциональные требования

* Аудит/логирование всех операций админа (изменение статуса, генерация AI)

* Роли и права: admin, seller, buyer

* Версионирование тестов и деревьев (минимально хранить updated_at и id версий)

* Масштабируемость: сегменты — произвольное число, слоты — слот_count на сегмент

* Нотификации (в перспективе): WebSocket/Kafka для аукционов/модерации

1. Валидации/правила (основные)

* Promotion READY_TO_START если:

  * Даты валидны и date_from < date_to

  * Есть ≥1 сегмент

  * Проставлены категории для каждого сегмента

  * pricing_model=auction: minPrice > 0, bidStep > 0

  * pricing_model=fixed: заданы цены для 1..slot_count

  * identification_mode=questions: есть ≥1 вопрос с ≥2 опциями; дерево (optional для MVP)

  * identification_mode=user_profile: бэк умеет маппить профиль → сегмент

* Seller bid: amount >= minBid и (amount - currentMin) % bidStep == 0

* Fixed buy: слот статус available, после покупки → pending (модерация)

* Moderation: approve → slot.occupied + product bind; reject → slot.available

1. Миграции (с учётом текущего init.sql)

* Добавить таблицы: segment, test_question, test_option, test_answer_tree, slot, moderation

* Изменить auction/bet: связь на slot (auction.slot_id FK) вместо horoscope_id/position, либо добавить slot_id и оставить обратную совместимость

* Расширить promotion колонками из п.2.1

* Оставить horoscope для темы 'zodiac' (backward compatibility); в будущем возможно заменить на segment_text

1. Примеры DTO (схемы)

* PromotionDTO (Admin GET) { id, name, description, theme, status, date_from, date_to, identification_mode, pricing_model, slot_count, min_discount, max_discount, stop_factors: string[], segments: [{id,name,category_name,order_index}], fixed_prices?: {[position:number]: number}, test?: { questions: [{id,text,options:[{id,text,value}]}], answerTree: [{node_id,parent_node_id,label,value}] } }

* SegmentSlotsDTO (Seller GET) { auction: [{slotId, position, currentBid, minBid, bidStep, timeLeft, topBidderName?}], fixed: [{slotId, position, price, status}] }

* ModerationApplicationDTO { id, promotionId, segmentId, slotId, sellerId, productName, price, discount, stop_factors: string[], status }

1. План releases (MVP → расширение)

* MVP:

  * CRUD акций/сегментов/цен/тестов

  * Идентификация по вопросам

  * Аукцион и фикс модель на слотах

  * Модерация

  * Публичная витрина (лендинг + товары)

* Расширение:

  * Идентификация по профилю

  * AI генерация текста и персон. копирайта (hero/подзаголовки)

  * WS/RT обновления ставок

  * Уведомления селлерам/админам

Эта спецификация задаёт полные рамки “генератора акций” и совместима с вашим начальным “гороскопным” кейсом (через theme=zodiac). Контракты REST позволяют фронту реализовать все сценарии из макетов и новых требований, а БД-расширения обеспечивают универсальность по темам/сегментам и моделям монетизации слотов.