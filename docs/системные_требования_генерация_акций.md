# Системные требования: «Генерация акций»

## 1. Введение и контекст

### 1.1. Назначение документа
Этот документ фиксирует системные требования к проекту «Генерация акций» как к универсальной платформе тематических промо-кампаний (не только гороскопных), включая:
- продуктовые сценарии для Buyer, Seller, Admin;
- системные требования к backend, API, данным и интеграциям;
- нефункциональные требования;
- границы MVP1/MVP2;
- разрывы между целевой моделью и текущей реализацией backend.

### 1.2. Контекст эволюции
Проект стартовал как концепция «гороскопных скидок» (персонализированная еженедельная акция по знаку зодиака) и был расширен до универсального генератора акций с произвольной тематикой и сегментами.

Ключевая эволюция:
- `horoscope/zodiac` -> `promotion + segments`;
- ручной сценарий и гороскопная витрина -> платформа тематических акций;
- один сценарий монетизации -> `auction` и `fixed` slot pricing;
- статичный UX -> AI-assisted генерация тем/сегментов/текстов/опросов;
- частная идея -> системный продукт с ролями Buyer/Seller/Admin.

### 1.3. Область охвата документа
Документ покрывает весь продукт:
- Buyer-часть (витрина акций и идентификация сегмента);
- Seller-часть (участие в слотах, ставки/покупка, заявки);
- Admin-часть (создание и управление акциями, сегментами, модерацией, AI-assisted функции);
- Backend (gRPC + gRPC-Gateway, бизнес-логика, БД PostgreSQL, интеграционные контуры);
- Нефункциональные требования и ограничения эксплуатации.

## 2. Эволюция концепции (Original -> Revised)

### 2.1. Исходная концепция (гороскопные скидки)
Исходная идея фокусировалась на:
- еженедельной персонализированной акции по знаку зодиака;
- эмоциональном контексте (гороскопный текст/баннер);
- слотах для селлеров по знакам и позициям;
- возможной монетизации через продажу слотов/аукцион;
- ручной модерации/ограничениях и базовой аналитике.

Ограничения исходной концепции:
- доменная связка только с гороскопом;
- риск чрезмерной завязки на один сценарий идентификации и одну тему.

### 2.2. Обновлённая концепция (генератор акций)
После презентации идея была расширена до платформы:
- `theme` задаёт тематику акции (`zodiac`, `harry-potter`, сезонность и т.д.);
- `segment` становится универсальной единицей таргетирования/витрины;
- идентификация работает в двух режимах: `questions` или `user_profile`;
- слоты поддерживают `auction` и `fixed` модели ценообразования;
- добавлена модель модерации заявок для селлеров;
- AI используется как сервис-помощник.

## 3. Глоссарий и нормализация терминов

### 3.1. Карта терминов (бизнес -> технический alias)

| Бизнес-термин | реализация | Комментарий |
|---|---|---|
| Акция | `promotion` | Центральная сущность кампании |
| Сегмент акции | `segment` | Универсальный сегмент (знак, факультет, сезонный сегмент и т.д.) |
| Идентификационный тест | `poll` (в текущем backend) | В To-Be документах также используется `test` |
| Слот | `slot` | Позиция в сегменте для товара/ставки |
| Аукцион | `auction`, `bet` | В текущей БД один `auction` на `promotion`, ставки по слотам |
| Модерация | `moderation` | Заявки на fixed-сценарий и решения approve/reject |
| Ручной режим WB | `SetSlotProduct` / ручная привязка товара к слоту | WB заполняет слот без seller flow |

## 4. Область системы и роли

### 4.1. Роли
- `Buyer` (покупатель): видит текущую акцию, проходит идентификацию сегмента, просматривает товары сегмента.
- `Seller` (селлер): видит доступные акции/сегменты/слоты, ставит ставки или покупает fixed-слоты, отправляет товары на модерацию.
- `Admin` (администратор/маркетинг): создаёт и настраивает акции, сегменты, цены, идентификацию, модерацию, запуск/пауза/завершение.

### 4.2. Системные акторы и подсистемы
- Backend API (gRPC + gRPC-Gateway REST facade)
- PostgreSQL
- AI service (генерация тем/сегментов/опроса/текстов)
- Frontend-приложения: Buyer витрина, Seller кабинет, Admin кабинет

## 5. Высокоуровневая архитектура системы

### 5.1. Целевая архитектурная модель (To-Be)
Подсистемы:
- `Admin Management`: управление акциями, сегментами, pricing, идентификацией, модерацией
- `Seller Participation`: доступные акции/сегменты/слоты, ставки, fixed-покупка, заявки
- `Buyer Showcase`: текущая акция, сегменты, товары, идентификация сегмента
- `AI Assist`: генерация тем/сегментов/вопросов/дерева/текстов
- `Data Layer`: PostgreSQL (promotion, segment, poll/test, slot, auction, bet, moderation, product)
- `Event/RT Layer` (MVP2): события аукциона и обновления статусов

### 5.2. Фактический backend-контур (As-Is)
Текущая ветка реализует backend как:
- gRPC-сервер + gRPC reflection (`internal/app/grpc_server.go`)
- HTTP REST через gRPC-Gateway (`internal/app/app.go`)
- protobuf-контракты в `api/proto/*.proto`
- PostgreSQL-репозитории и миграция `migrations/20251108161617_init.sql`

Подтверждение использования gRPC-gateway:
- регистрация handler'ов в `internal/app/app.go`

## 6. Функциональные требования (по ролям и сценариям)

### 6.1. Buyer (покупатель)

#### FR-BUY-001. Получение текущей активной акции
Система должна предоставлять endpoint для получения текущей активной акции с базовыми полями акции и списком сегментов.

Предусловия:
- Существует акция в статусе `RUNNING` в интервале `date_from <= now <= date_to`.

Основной поток:
1. Buyer открывает витрину акции.
2. Frontend запрашивает текущую акцию.
3. Backend возвращает данные акции и сегменты.

Альтернативные потоки:
- Нет активной акции -> пустой ответ/нет данных (корректное состояние витрины).

Постусловия:
- Frontend может показать hero/список сегментов.

#### FR-BUY-002. Получение товаров сегмента
Система должна отдавать товары выбранного сегмента с поддержкой фильтров, сортировки, пагинации и признака завершённой акции (`completed`).

Предусловия:
- Сегмент принадлежит акции.
- В сегменте есть занятые слоты (`occupied`) с товарами или система возвращает пустой список.

Основной поток:
1. Buyer выбирает сегмент.
2. Frontend отправляет запрос с фильтрами.
3. Backend возвращает список товаров, total, page/per_page, completed.

Ошибки:
- Невалидный `promotionId/segmentId` -> ошибка валидации/не найдено.

#### FR-BUY-003. Идентификация сегмента: старт
Система должна запускать идентификацию сегмента для акции в режиме:
- `questions` (выдача теста/опроса)
- `user_profile` (определение сегмента по профилю)

#### FR-BUY-004. Идентификация сегмента: ответ
Система должна принимать ответы на вопросы и возвращать:
- следующий вопрос, либо
- итоговый `resultSegmentId`

#### FR-BUY-005. Состояния витрины
Система должна поддерживать корректные состояния:
- `empty` (нет товаров)
- `completed` (акция завершена)
- `loading/fallback` (на стороне UI как реакция на API)

### 6.2. Seller (селлер)

#### FR-SEL-001. Просмотр доступных акций
Система должна отдавать список доступных акций для участия селлера с базовой информацией (статус, даты, тема, category hint).

#### FR-SEL-002. Просмотр сегментов акции
Система должна отдавать список сегментов выбранной акции с доступностью слотов, общим числом слотов и агрегатной информацией.

#### FR-SEL-003. Просмотр слотов сегмента
Система должна отдавать структуру слотов по сегменту с разделением по моделям:
- `auction`
- `fixed`

#### FR-SEL-004. Участие в аукционе (ставка)
Система должна позволять селлеру сделать ставку по слоту при выполнении правил:
- слот доступен,
- сумма >= минимальной,
- соблюдён шаг ставки,
- товар принадлежит селлеру.

#### FR-SEL-005. Покупка fixed-слота
Система должна позволять селлеру занять fixed-слот через отправку товара на модерацию.

Ожидаемое поведение:
- слот переходит в состояние ожидания модерации;
- создаётся заявка в `moderation`;
- seller получает статус `pending_moderation`.

#### FR-SEL-006. Отмена ставки/заявки
Система должна поддерживать отмену участия селлера в рамках допустимых статусов и правил владения.

#### FR-SEL-007. Просмотр заявок/ставок селлера
Система должна отдавать список ставок и заявок селлера со статусами, связью с акцией/сегментом/слотом.

### 6.3. Admin (администратор)

#### FR-ADM-001. Создание акции
Система должна позволять создать акцию в статусе `NOT_READY`.

Минимальные параметры:
- имя, описание, тема
- даты
- mode идентификации
- pricing model
- параметры слотов/ограничений

#### FR-ADM-002. Получение и обновление акции
Система должна отдавать полную конфигурацию акции и поддерживать частичное обновление.

#### FR-ADM-003. Управление статусом акции
Система должна поддерживать смену статуса акции через state machine и валидацию готовности.

#### FR-ADM-004. Управление сегментами
Система должна поддерживать:
- генерацию сегментов (AI-assisted)
- CRUD сегментов
- перестановку категорий сегментов

#### FR-ADM-005. Управление pricing для слотов
Система должна поддерживать:
- аукционную модель (минимальная цена, шаг)
- fixed-модель (цены по позициям)

#### FR-ADM-006. Управление идентификацией (poll/test)
Система должна поддерживать:
- генерацию вопросов/дерева (AI-assisted)
- ручную загрузку вопросов и дерева
- получение конфигурации идентификации в составе акции

#### FR-ADM-007. Ручная привязка товара к слоту (WB curation)
Система должна поддерживать ручной режим заполнения слотов товарами без участия seller flow.

#### FR-ADM-008. Модерация заявок селлеров
Система должна поддерживать:
- просмотр заявок по акции и статусу
- approve/reject
- корректное обновление статуса слота и привязки товара

#### FR-ADM-009. AI-assisted функции
Система должна предоставлять сервисные интерфейсы для генерации:
- тем
- сегментов
- вопросов
- дерева ответов
- текстов (акция/сегмент)

## 7. Доменная модель и бизнес-сущности

### 7.1. Promotion (акция)
Назначение: агрегирует настройки кампании, сегменты, правила идентификации и монетизации.

Ключевые поля (To-Be):
- `id`
- `name`, `description`
- `theme`
- `date_from`, `date_to`
- `status`
- `identification_mode`
- `pricing_model`
- `slot_count`
- ограничения по скидкам/ценам/стоп-факторам
- fixed prices (для fixed модели)

Ключевые поля (As-Is backend):
- `discount` (WB discount)
- `min_price`, `bid_step` (в БД и entity)
- `fixed_prices` (jsonb)
- `stop_factors` (jsonb)

### 7.2. Segment (сегмент акции)
Назначение: таргет-группа/витрина в рамках акции.

Поля:
- `id`, `promotion_id`
- `name`
- `category_id`, `category_name`
- `order_index`
- `color` (опционально)
- `text` (AI-generated/manual)

### 7.3. Идентификационный тест (Poll/Test)
Назначение: определение сегмента пользователя через вопросы и дерево ответов.

To-Be терминология: `test_question`, `test_option`, `test_answer_tree`
As-Is backend: `poll_question`, `poll_option`, `poll_answer_tree`

### 7.4. Slot
Назначение: место в сегменте под размещение товара.

Поля:
- `promotion_id`, `segment_id`
- `position`
- `pricing_type` (`auction` | `fixed`)
- `price` (для fixed)
- `auction_id` (если slot участвует в аукционе)
- `status`
- `seller_id`, `product_id`

Статусы слота (As-Is):
- `available`
- `occupied`
- `pending`
- `moderation`
- `rejected`

### 7.5. Auction и Bet
Текущая As-Is модель:
- один `auction` на `promotion`
- ставки (`bet`) привязаны к конкретному `slot`

### 7.6. Moderation
Назначение: хранение заявок селлеров на размещение в fixed-слотах и результата модерации.

Ключевые поля:
- `promotion_id`, `segment_id`, `slot_id`, `seller_id`, `product_id`
- `discount`
- `stop_factors`
- `status`
- `moderated_at`, `moderator_id`

## 8. Требования к данным и БД

### 8.1. Логическая модель (To-Be)
Логические сущности и связи:
- `Promotion 1-N Segment`
- `Promotion 1-N PollQuestion`
- `PollQuestion 1-N PollOption`
- `Promotion 1-N PollAnswerTreeNode`
- `Promotion 1-N Slot`
- `Segment 1-N Slot`
- `Promotion 1-1 Auction`
- `Auction 1-N Bet`
- `Slot 1-N Bet`
- `Promotion 1-N Moderation`
- `Slot 1-N Moderation`
- `Product` связан с `Slot`, `Bet`, `Moderation`

### 8.2. Ограничения целостности (обязательные требования)
Система должна обеспечивать:
- валидные FK между `promotion/segment/slot/product/...`
- уникальность аукциона на промо (если остаётся модель `1 promotion -> 1 auction`)
- консистентность статусов слота и модерации
- запрет на размещение продукта, не принадлежащего селлеру
- мягкое удаление для сущностей, где это предусмотрено (`promotion`, `product`, `auction`, `bet`)

## 9. Контракты API и интерфейсы

### 9.1. Целевые API (To-Be)

#### Buyer
- `GET /promotions/current`
- `GET /promotions/{promotionId}/segments/{segmentId}/products`
- `POST /identification/start`
- `POST /identification/answer`

#### Seller
- `GET /seller/actions`
- `GET /seller/actions/{promotionId}/segments`
- `GET /seller/actions/{promotionId}/segments/{segmentId}/slots`
- `POST /seller/slot/bid`
- `POST /seller/slot/buy-fixed`
- `POST /seller/slot/cancel`
- `GET /seller/applications`

#### Admin
- `POST /admin/promotions`
- `GET /admin/promotions/{id}`
- `PATCH /admin/promotions/{id}`
- `DELETE /admin/promotions/{id}`
- `PUT /admin/promotions/{id}/fixed-prices`
- `PUT /admin/promotions/{id}/status`
- `POST /admin/promotions/{id}/segments/generate`
- `POST/PATCH/DELETE` для сегментов
- `POST /admin/promotions/{id}/poll(or test)/...`
- `GET /admin/promotions/{id}/moderation/applications`
- `POST /admin/moderation/{applicationId}/approve|reject`
- endpoint ручной привязки товара к слоту (нормализованный путь)

### 9.2. Требования к кодам ошибок и ответам (To-Be)
Backend должен унифицировать ошибочные ответы (REST через gateway):
- `400` — валидация параметров/правил (например, шаг ставки, невалидный статус)
- `404` — сущность не найдена
- `409` — конфликт состояния (слот занят, статус не позволяет операцию)
- `403` — нет прав/товар не принадлежит селлеру
- `500` — системная ошибка

## 10. Правила, валидации и state machine

### 10.1. Статусы акции
Поддерживаемые статусы:
- `NOT_READY`
- `READY_TO_START`
- `RUNNING`
- `PAUSED`
- `COMPLETED`

### 10.2. Целевая state machine (To-Be)
Допустимые переходы:
- `NOT_READY -> READY_TO_START`
- `READY_TO_START -> RUNNING`
- `RUNNING -> PAUSED`
- `PAUSED -> RUNNING`
- `RUNNING -> COMPLETED`
- `PAUSED -> COMPLETED`
- `READY_TO_START -> NOT_READY` (при изменении конфигурации)

Запрещённые переходы должны отклоняться с ошибкой валидации/конфликта состояния.

### 10.3. Валидатор готовности акции (обязательное требование To-Be)
Для `NOT_READY -> READY_TO_START` система должна проверять:
- `date_from < date_to`
- есть >= 1 сегмент
- сегменты имеют корректные категории (если это обязательное правило для темы/режима)
- `pricing_model=auction`: заданы и валидны `min_price`, `bid_step`
- `pricing_model=fixed`: заданы цены для позиций `1..slot_count`
- `identification_mode=questions`: есть вопросы и опции; дерево ответов — по правилам версии MVP
- `identification_mode=user_profile`: есть реализованная стратегия маппинга профиля -> сегмент

### 10.4. Валидаторы seller flow

#### Аукцион
Система должна проверять:
- слот существует и доступен для аукциона
- сумма ставки >= минимальной
- шаг ставки соблюдён
- товар существует и принадлежит селлеру
- при необходимости: ставка выше текущей лучшей ставки (To-Be для полноценного аукциона)

#### Fixed-slot
Система должна проверять:
- слот существует и `available`
- товар принадлежит селлеру
- discount товара/предложения соответствует ограничениям акции
- стоп-факторы/категория не нарушены (автоотказ или перевод на ручную модерацию)

### 10.5. Валидаторы модерации
- `approve` -> слот становится `occupied`, фиксируется товар
- `reject` -> слот возвращается в `available`, привязки селлера/товара очищаются
- повторная обработка уже обработанной заявки должна быть запрещена/явно описана

## 11. Нефункциональные требования (NFR)

### 11.1. Надёжность и консистентность
- Система должна обеспечивать атомарность критичных переходов статусов (slot/moderation/approve-reject).
- Операции изменения статусов и модерации должны быть идемпотентны или явно защищены от повторного применения.

### 11.2. Безопасность и доступ
- Ролевое разграничение: `admin`, `seller`, `buyer`.
- Проверка владения товаром для seller операций обязательна на backend.
- Аудит админских действий обязателен минимум на уровне бизнес-событий (создание/обновление акции, смена статуса, модерация).

## 12. Тестовые сценарии и кейсы (обязательные для включения в реализацию/QA)

### 12.1. Основные сценарии
1. Создание акции админом в статусе `NOT_READY`.
2. Перевод акции в `READY_TO_START` с валидацией готовности.
3. Запуск, пауза, завершение акции и влияние на buyer витрину.
4. CRUD сегментов и сохранение `order_index`.
5. Генерация сегментов (AI-assisted) и fallback при недоступном AI.
6. Настройка fixed prices по позициям `1..slot_count`.
7. Настройка аукциона (`min_price`, `bid_step`) и публикация слотов.
8. Seller ставка по аукциону: успех, ошибка шага, ошибка минимальной ставки.
9. Seller fixed purchase -> заявка на модерацию -> approve.
10. Seller fixed purchase -> reject -> освобождение слота.
11. Buyer просмотр текущей акции при отсутствии активной акции.
12. Buyer просмотр товаров сегмента: пустой сегмент, непустой сегмент, completed.
13. Buyer identification flow (`questions`) до получения `resultSegmentId`.
14. Buyer identification flow (`user_profile`) c прямым определением сегмента.

### 12.2. Негативные и пограничные кейсы
1. Невалидный переход статуса акции.
2. Изменение статуса без обязательных данных (segments/pricing/identification).
3. Ставка в занятый слот.
4. Ставка с товаром, не принадлежащим селлеру.
5. Отмена участия в недопустимом статусе.
6. Повторная модерация уже обработанной заявки.
7. Конфликт pricing model и параметров запроса.
8. Невалидные `page/per_page/sort` параметры.
9. Сбой AI-сервиса во время генерации (fallback поведение).

## 13. Матрица трассируемости (требование -> API -> БД -> код -> тест-кейс)

| Requirement ID | API/интерфейс | БД/таблицы | Backend (As-Is) |
|---|---|---|---|
| FR-BUY-001 | `GET /promotions/current` | `promotion`, `segment` | `api/proto/buyer.proto`, `internal/api/buyer/service.go`, `internal/service/buyer/service.go`, `internal/repository/promotion_postgres.go` |
| FR-BUY-002 | `GET /promotions/{promotionId}/segments/{segmentId}/products` | `slot`, `product`, `promotion` | `api/proto/buyer.proto`, `internal/api/buyer/service.go`, `internal/service/buyer/service.go`, `internal/repository/slot_postgres.go`, `internal/repository/product_postgres.go` |
| FR-BUY-003/004 | `/identification/start`, `/identification/answer` | `poll_question`, `poll_option`, `poll_answer_tree` | `api/proto/buyer.proto`, `internal/api/buyer/service.go` (gap), `internal/repository/poll_postgres.go` (stub) |
| FR-SEL-001 | `GET /seller/actions` | `promotion`, `segment`, `slot` | `api/proto/seller.proto`, `internal/api/seller/service.go`, `internal/service/seller/service.go` (stub) |
| FR-SEL-004 | `POST /seller/bets/make` (As-Is), target `/seller/slot/bid` | `auction`, `bet`, `slot`, `product` | `internal/service/seller/service.go`, `internal/repository/auction_postgres.go`, `internal/repository/bet_postgres.go` |
| FR-SEL-005 | `POST /seller/bets/make` (fixed branch), target `/seller/slot/buy-fixed` | `slot`, `moderation`, `product` | `internal/service/seller/service.go`, `internal/repository/moderation_postgres.go` |
| FR-SEL-006 | `POST /seller/bets/remove` | `bet`, `slot` | `internal/service/seller/service.go`, `internal/repository/bet_postgres.go`, `internal/repository/slot_postgres.go` |
| FR-ADM-001 | `POST /admin/promotions` | `promotion` | `api/proto/admin.proto`, `internal/api/admin/service.go`, `internal/service/promotion/service.go`, `internal/repository/promotion_postgres.go` |
| FR-ADM-004 | Segment CRUD endpoints | `segment` | `api/proto/admin.proto`, `internal/api/admin/service.go`, `internal/service/promotion/service.go`, `internal/repository/segment_postgres.go` |
| FR-ADM-005 | `PUT /admin/promotions/{id}/fixed-prices` | `promotion.fixed_prices` | `api/proto/admin.proto`, `internal/api/admin/service.go`, `internal/service/promotion/service.go` |
| FR-ADM-006 | `PollAdminService` (`/poll/...`) | `poll_*` | `api/proto/admin.proto`, `internal/api/admin/service.go` (gap), `internal/repository/poll_postgres.go` (stub) |
| FR-ADM-008 | Moderation endpoints | `moderation`, `slot`, `product` | `api/proto/admin.proto`, `internal/api/admin/service.go`, `internal/service/promotion/service.go`, `internal/repository/moderation_postgres.go` |
| FR-ADM-009 | `/ai/*` | (нет обязательной БД привязки) | `api/proto/ai.proto`, `internal/api/ai/service.go`, `internal/service/ai/service.go` (stub) |
| FR-SYS-001 | HTTP facade via gateway | n/a | `internal/app/app.go`, `cmd/server/main.go` |
| FR-DATA-001 | Legacy `theme=zodiac` compatibility | `zodiac`, `horoscope`, `horoscope_product` + new model | `migrations/20251108161617_init.sql` |

## 18. Приложение A. Источники анализа

### 18.1. Концептуальные документы
- `docs/спецификация.md`
- `docs/архитектура.md`
- `docs/arch_detailed_old.md`
- `docs/«Гороскопные_Скидки_твоя_неделя_в_товарах».docx`
- `docs/Команда_Маркетинговых_Инструментов.pptx`